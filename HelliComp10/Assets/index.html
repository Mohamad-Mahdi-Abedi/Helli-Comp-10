<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monaco Editor - Python</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        #container {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
    </style>
    <script src="file:////C:/Temp/monaco-temp/node_modules/monaco-editor/min/vs/loader.js"></script>
    <script>
        require.config({ paths: { vs: 'file:////C:/Temp/monaco-temp/node_modules/monaco-editor/min/vs/' } });

        require(['vs/editor/editor.main'], function () {
            monaco.editor.defineTheme('dark-plus-custom', { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#272727' } });
            monaco.editor.defineTheme('light-custom', { base: 'vs', inherit: true, rules: [], colors: { 'editor.background': '#f9f9f9' } });

            const sample = `class Person:
            def __init__(self, name: str):
                self.name = name

            def say_hello(self):
                print(f"Hello, {self.name}!")

p = Person("World")
p.say_hello()`;

            window.editor = monaco.editor.create(document.getElementById('container'), {
                value: sample,
                language: 'python',
                theme: 'dark-plus-custom',
                automaticLayout: true,
                fontFamily: 'Ubuntu Mono'
            });

            function setEditorTheme() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    monaco.editor.setTheme('dark-plus-custom');
                } else {
                    monaco.editor.setTheme('light-custom');
                }
            }
            setEditorTheme();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setEditorTheme);

            // تابع ارسال وضعیت
            function sendStatus() {
                const model = editor.getModel();
                const totalLines = model.getLineCount();
                const totalChars = model.getValueLength();

                const position = editor.getPosition();
                const selection = editor.getSelection();

                let selectionInfo = null;
                if (!selection.isEmpty()) {
                    const selectedLines = selection.endLineNumber - selection.startLineNumber + 1;
                    const selectedChars = model.getValueInRange(selection).length;
                    selectionInfo = {
                        startLine: selection.startLineNumber,
                        startColumn: selection.startColumn,
                        endLine: selection.endLineNumber,
                        endColumn: selection.endColumn,
                        selectedLines: selectedLines,
                        selectedChars: selectedChars
                    };
                }

                const status = {
                    totalLines,
                    totalChars,
                    cursorLine: position.lineNumber,
                    cursorColumn: position.column,
                    selection: selectionInfo
                };

                window.chrome.webview.postMessage({ type: "status", data: status });
            }

            // ارسال وضعیت در هر تغییر متن
            editor.onDidChangeModelContent(sendStatus);

            // ارسال وضعیت در هر حرکت نشانگر
            editor.onDidChangeCursorPosition(sendStatus);
            editor.onDidChangeCursorSelection(sendStatus);

            // دریافت پیام از C#
            window.chrome.webview.addEventListener('message', event => {
                let data = event.data;
                if (typeof data === "object" && data.type) {
                    if (data.type === "getContent") {
                        const code = window.editor.getValue();
                        window.chrome.webview.postMessage({ type: "content", content: code });
                    } else if (data.type === "setContent") {
                        window.editor.setValue(data.content);
                    }
                }
            });

            // Ctrl+S
            window.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                    e.preventDefault();
                    const code = window.editor.getValue();
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.postMessage({ type: "save", content: code });
                    }
                }
            });
        });
    </script>
</head>
<body>
    <div id="container"></div>
</body>
</html>
